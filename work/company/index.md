### 业务架构系列

* 架构图
![业务架构](images/架构图_fc.png)

* 架构说明
    - 终端分为：柜机app、快递员app、消费者app、公众号、小程序等
    - 重点是柜机app的pb请求，通过nginx（keepalive）打到流量分发微服务
    - 流量分发微服务主要功能：解析pd协议、请求业务微服务、异步kafka消息快速响应解耦、柜机JWT Token生成和校验
        * 通过一个指定的secret生成为每个柜机编码生成一个带过期时间的token
        * 提供一个校验和刷新token的接口
    - 业务微服务接受流量分发服务的请求数据来处理业务逻辑
        * 核心微服务：登录、校验、支付、派取
        * 扩展微服务：广告、寄件、储物、彩票...
    - 基础平台微服务承接业务微服务的请求
        * 用户、支付、推送、柜机...
        * 对外的开放平台微服务：承接合作方请求和消息推送
    - 数据平台统计和微服务业务
        * 数据接入层：日志、数据库、kafka（flink）消息等
        * 数据库存储：kudu、hive、hbase、mysql等
        * 数据接口层：提供给业务系统和报表系统接口
        * 报表展示层：报表、监控等
        
* 核心说明
    - 柜机app重点逻辑：
        1. 取件码柜机生产，保证当前柜机取件码不重复（判断是否已经存在）
        2. 运单号+格口+柜机编码+postId等信息存在柜机端
        3. postId生成唯一的丰巢订单号：FC+柜机编码+日期+时间戳
        4. 网络重发，加强服务的可靠性
        5. 离线取件，提高消费者体验
    - 流量分发服务重点逻辑：
        1. 通过jwt校验柜机请求的token
        2. 同步调用业务微服务接口
        3. 异步请求写kafka
        4. 写log1就请求的订单信息
        5. 熔断、降级和水平扩容
    - 核心业务微服务重点逻辑：
        1. 消费kafka，利用postId通过redis的bloom filter去重
        2. 写db，建立唯一索引，可以用于二次去重，捕捉唯一索引冲突
        3. 写log2，跟log1做对比，找出差异自动重新灌入kafka重新消费
        4. 写redis，记录已经处理派件入柜的post信息，方便后期查询服务
        5. 写入业务方对应的二级kafka，拆分数据总线kafka，防止reblance重新选举时间过长，业务隔离，保证稳定性
    - 最终一致性的方案：
        1. 业务方提供消费kafka消费封装的sdk
        2. 实现sdk接口处理自身业务逻辑会主动回调业务方封装的dubbo接口
        3. 业务方提供查询接口，保证调用方兜底调用  
            实例  
                1. 调用方调用支付系统接口支付，然后轮询或回调获得支付结果
                2. 支付系统调用支付服务商接口（微信或者支付宝），然后轮询或回调获得支付结果
                3. 支付系统获得支付结果后将消息丢入kafka
                4. 调用方实现支付系统sdk的接口，消费kafka，然后入库支付结果
                5. 支付系统sdk会回调支付系统通知消费成功
                
        
        
        